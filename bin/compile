#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>
echo "-----> Installing 7zip 16.02"

BUILD_DIR=$1
PACKAGE="https://sourceforge.net/projects/p7zip/files/p7zip/16.02/p7zip_16.02_src_all.tar.bz2"
LOCATION="$BUILD_DIR/vendor/7zip"

echo $BUILD_DIR

mkdir -p $LOCATION
echo "-----> Fetching 7zip source"
cd $LOCATION
curl $PACKAGE -OL

echo "-----> Unzipping 7zip"
tar xjvf p7zip_16.02_src_all.tar.bz2 -C $LOCATION

echo "-----> Building 7zip from source"
cd p7zip_16.02

echo "-----> Building setting soruce makefile"
cp makefile.linux_x86_asm_gcc_4 makefile.machine

echo "-----> Running make..."
make

echo "-----> Running 7zip tests"
make test

echo "-----> exporting PATH and LIBRARY_PATH"

PROFILE_PATH="$BUILD_DIR/.profile.d/7za.sh"

mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="$PATH:$HOME/vendor/7zip/p7zip_16.02/bin' >> $PROFILE_PATH